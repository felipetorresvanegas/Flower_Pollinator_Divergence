---
title: "REDUCED-RANK REGRESSION IN HMSC: Pollination Traits and Mean Number of Flower Visits at the Population Level"
---

```{r include=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(reshape2)
library(tidyr)
library(Hmsc)
library(stringr)
```

# Load Data for Reduced-Rank Regression

```{r}
data_flower_traits <- readRDS(paste0(here::here("Data/Data_Pollination_Traits_Master.rds")))
```

```{r}
data_pollinators <- readRDS(paste0(here::here("Data/Data_Pollinators_Master.rds")))
```

```{r}
data_reduced_rank_regression <- list(Flower_Traits = data_flower_traits, Pollinators = data_pollinators)
```

# Prepare Data for Reduced-Rank Regression

## Mean Number of Flower Visits per Population

```{r}
data_flower_visits_mean <- data_reduced_rank_regression$Pollinators %>% 
  group_by(Population) %>% 
  summarise(across(Bombus_Queen:Syrphidae, mean), .groups = "drop")
```

## Mean Pollination Traits per Population

```{r}
data_flower_traits_mean <- data_reduced_rank_regression$Flower_Traits %>% 
  group_by(Population) %>% 
  summarise(across(Stem_Height:NSD, ~ mean(.x, na.rm = TRUE)), .groups = "drop")
```

```{r}
data_flower_traits_mean <- data_flower_traits_mean %>% 
  mutate(log_Stem_Height = log(Stem_Height),
         log_Total_Flowers = log(Total_Flowers),
         log_Corolla_Diameter = log(Corolla_Diameter),
         log_Tube_Width = log(Tube_Width),
         log_Tube_Length = log(Tube_Length),
         log_NSD = log(NSD)) %>% 
  select(Population, log_Stem_Height, log_Total_Flowers, log_Corolla_Diameter, log_Tube_Width, log_Tube_Length, log_NSD)
```

# Assemble Data for Reduced-Rank Regression

```{r}
data_flower_traits_flower_visits_population <- merge(data_flower_traits_mean,
                                                     data_flower_visits_mean,
                                                     by = "Population",
                                                     all = TRUE)
```

```{r}
data_pollinator_population_mean <- data_flower_traits_flower_visits_population %>% 
  select(Population, Bombus_Queen:Syrphidae)
```

```{r}
data_pollinator_population_variance_scaled <- data_pollinator_population_mean %>% 
  mutate(across(Bombus_Queen:Syrphidae, ~ (. - mean(.)) / sd(.)))
# each value in the column (.) has the column mean subtracted (mean(.)) and then divided by the column standard deviation (sd(.))
# mean of zero and standard deviation of one
```

# Basic Data Information for Reduced-Rank Regression

```{r}
RRR_info_intercept <- data.frame(Intercept = rep(1, nrow(data_flower_traits_flower_visits_population)))
```

```{r}
RRR_info_study_design <- data_flower_traits_flower_visits_population %>% 
  select(Population) %>% 
  mutate_at(vars(Population),
            as.factor)
```

## Define Random Levels

```{r}
RRR_info_random_level_population <- HmscRandomLevel(units = unique(RRR_info_study_design$Population))
```

## Define Model Formula

```{r}
RRR_info_model_formula = ~ 1
```

```{r}
RRR_info_model_formula_pollinator_groups <- as.formula(paste("~", "- 1 +", paste0(colnames(data_pollinator_population_mean %>% 
                                                                                             select(Bombus_Queen:Syrphidae)),
                                                                                  collapse = "+")))
```

# Define HMSC Model

```{r}
identical(data_flower_traits_mean$Population,
          data_flower_visits_mean$Population,
          RRR_info_study_design$Population)
```

```{r}
RRR_model_abundance <- Hmsc(Y = data_flower_traits_mean %>%
                              select(log_Stem_Height:log_NSD),
                            XData = RRR_info_intercept,
                            XFormula = RRR_info_model_formula,
                            XRRRData = data_pollinator_population_variance_scaled %>% 
                              select(Bombus_Queen:Syrphidae),
                            XRRRFormula = RRR_info_model_formula_pollinator_groups,
                            ncRRR = 2,
                            distr = "normal",
                            studyDesign = RRR_info_study_design,
                            ranLevels = list(Population = RRR_info_random_level_population))
```

# Sample MCMC

```{r}
model_HMSC_samples <- 1000
model_HMSC_thin <- 100
model_HMSC_adaptNf <- ceiling(0.4 * model_HMSC_samples  * model_HMSC_thin)
model_HMSC_transient <- ceiling(0.5 * model_HMSC_samples * model_HMSC_thin)
```

```{r}
RRR_model_abundance <- sampleMcmc(RRR_model_abundance,
                                  samples = model_HMSC_samples,
                                  thin = model_HMSC_thin,
                                  adaptNf = rep(model_HMSC_adaptNf, 1),
                                  transient = model_HMSC_transient,
                                  nChains = 2,
                                  nParallel = 2)
```

# Reduced-Rank Regression Weights

```{r}
RRR_model_abundance_weight_values <- getPostEstimate(RRR_model_abundance, parName = "wRRR")
```

```{r}
RRR_model_abundance_weight_values <- lapply(RRR_model_abundance_weight_values,
                                            function(df) {
                                              colnames(df) <- colnames(RRR_model_abundance$XRRRData)
                                              rownames(df) <- c("RRR_1", "RRR_2")
                                              df
                                              })
```

```{r}
data_RRR_model_abundance_weight_values <- data.frame(Pollinator_Group = colnames(RRR_model_abundance_weight_values$mean),
                                                     RRR_One_Weights = as.vector(RRR_model_abundance_weight_values$mean["RRR_1", ]),
                                                     RRR_Two_Weights = as.vector(RRR_model_abundance_weight_values$mean["RRR_2", ]))
```

# Reduced-Rank Regression 'Pollinator Assemblage Axis'

```{r}
RRR_model_abundance_weighted_sum_values <- as.matrix(RRR_model_abundance$XRRRData) %*% t(as.matrix(RRR_model_abundance_weight_values$mean))
```

```{r}
data_RRR_model_abundance_weighted_sum_values <- data.frame(Population = rep(RRR_model_abundance$studyDesign$Population, 6),
                                                           Trait = rep(c(colnames(RRR_model_abundance$Y)), each = nrow(RRR_model_abundance$Y)),
                                                           Mean_Trait_Value = c(RRR_model_abundance$Y[, "log_Stem_Height"],
                                                                                RRR_model_abundance$Y[, "log_Total_Flowers"],
                                                                                RRR_model_abundance$Y[, "log_Corolla_Diameter"],
                                                                                RRR_model_abundance$Y[, "log_Tube_Width"],
                                                                                RRR_model_abundance$Y[, "log_Tube_Length"],
                                                                                RRR_model_abundance$Y[, "log_NSD"]),
                                                           RRR_One = rep(RRR_model_abundance_weighted_sum_values[, "RRR_1"], 6),
                                                           RRR_Two = rep(RRR_model_abundance_weighted_sum_values[, "RRR_2"], 6))
```

# Construct Gradient for Reduced-Rank Regression

## Add 'Pollinator Assemblage Axis' to XData of Reduced-Rank Regression Model

```{r}
RRR_model_abundance$XData <- RRR_model_abundance$XData %>% 
  mutate(XRRR_1 = RRR_model_abundance_weighted_sum_values[, 1],
         XRRR_2 = RRR_model_abundance_weighted_sum_values[, 2])
```

## Construct Gradient for Reduced-Rank Regression

```{r}
source(paste0(here::here("R_Functions/constructGradientRRR.R")))
```

```{r}
RRR_construct_gradient <- constructGradientRRR(RRR_model_abundance, focalVariable = "XRRR_1", ngrid = 100)
```

```{r}
data_RRR_construct_gradient <- data.frame(Intercept = rep(1, nrow(RRR_construct_gradient$XDataNew)),
                                          RRR_1 = RRR_construct_gradient$XDataNew$XRRR_1,
                                          RRR_2 = RRR_construct_gradient$XDataNew$XRRR_2)
```

## Obtain Mean Value of Beta Parameter for Pollination Traits

```{r}
data_RRR_beta <- getPostEstimate(RRR_model_abundance, parName = "Beta")$mean

rownames(data_RRR_beta) <- c("Intercept", "RRR_1", "RRR_2")
```

## Matrix Multiplication to Estimate Predicted Values of Pollination Traits

```{r}
data_RRR_predicted_values_IL <- as.matrix(data_RRR_construct_gradient) %*% as.matrix(data_RRR_beta[, 1])
colnames(data_RRR_predicted_values_IL) <- "log_Stem_Height_Mean"

data_RRR_predicted_values_FN <- as.matrix(data_RRR_construct_gradient) %*% as.matrix(data_RRR_beta[, 2])
colnames(data_RRR_predicted_values_FN) <- "log_Flowers_Open_Mean"
  
data_RRR_predicted_values_CD <- as.matrix(data_RRR_construct_gradient) %*% as.matrix(data_RRR_beta[, 3])
colnames(data_RRR_predicted_values_CD) <- "log_Corolla_Diameter_Mean"
  
data_RRR_predicted_values_TW <- as.matrix(data_RRR_construct_gradient) %*% as.matrix(data_RRR_beta[, 4])
colnames(data_RRR_predicted_values_TW) <- "log_Tube_Width_Mean"
  
data_RRR_predicted_values_TL <- as.matrix(data_RRR_construct_gradient) %*% as.matrix(data_RRR_beta[, 5])
colnames(data_RRR_predicted_values_TL) <- "log_Tube_Length_Mean"
  
data_RRR_predicted_values_NSD <- as.matrix(data_RRR_construct_gradient) %*% as.matrix(data_RRR_beta[, 6])
colnames(data_RRR_predicted_values_NSD) <- "log_NSD_Mean"
```

```{r}
data_RRR_predicted_values <- bind_cols(data_RRR_predicted_values_IL,
                                       data_RRR_predicted_values_FN,
                                       data_RRR_predicted_values_CD,
                                       data_RRR_predicted_values_TW,
                                       data_RRR_predicted_values_TL,
                                       data_RRR_predicted_values_NSD)

data_RRR_predicted_values <- data_RRR_predicted_values %>% 
  mutate(XRRR_1 = data_RRR_construct_gradient$RRR_1)
```

## Prepare Data for Graphs

```{r}
data_plot_basics <- data.frame(RRR_One = RRR_model_abundance$XData$XRRR_1,
                               log_Stem_Height_Mean = RRR_model_abundance$Y[, 1],
                               log_Flowers_Open_Mean = RRR_model_abundance$Y[, 2],
                               log_Corolla_Diameter_Mean = RRR_model_abundance$Y[, 3],
                               log_Tube_Width_Mean = RRR_model_abundance$Y[, 4],
                               log_Tube_Length_Mean = RRR_model_abundance$Y[, 5],
                               log_NSD_Mean = RRR_model_abundance$Y[, 6])
```